{% extends "base.html" %}
{% load static %}
{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/discover_tours.css' %}">
{% endblock extra_styles %}
{% block content %}
<div class="search-filters">
    <!-- Implement search and filter form -->
</div>

<!-- Map Modal -->
<div id="mapModal" class="modal">
    <div class="modal-content">
        <span class="close-button">×</span> <!-- Changed class to 'close-button' for clarity -->
        <div id="map" style="height: 400px; width: 100%;"></div>
    </div>
</div>

<div class="all-tours">
    <h2>All Tours</h2>
    {% for tour in tours %}
    <div class="tour">
        <h3>{{ tour.title }}</h3>
        {% if tour.images.all %}
            <!-- Carousel -->
            <div id="carousel{{ forloop.counter }}" class="carousel slide" data-ride="carousel">
                <div class="carousel-inner">
                    {% for image in tour.images.all %}
                    <div class="carousel-item{% if forloop.first %} active{% endif %}">
                        <img src="{{ image.image.url }}" class="d-block w-100" alt="Image of {{ tour.title }}">
                    </div>
                    {% endfor %}
                </div>
                <a class="carousel-control-prev" href="#carousel{{ forloop.counter }}" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#carousel{{ forloop.counter }}" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>
        {% else %}
            <p>No images available.</p>
        {% endif %}
        <p class="tour-description">{{ tour.description }}</p>
        <p class="tour-location">Location {{ tour.location }} </p>
        <p class="tour-start">Start {{ tour.availability_start }}</p>
        <p class="tour-end">End  {{ tour.availability_end }}</p>
        <button class="show-map-button" onClick="showMap({{ tour.latitude|default:'51.505' }}, {{ tour.longitude|default:'-0.09' }}, '{{ tour.location|default:'Unknown location'|escapejs }}')">
            Show on Map
        </button>

        <!-- User interactions -->
        {% if user.is_authenticated %}
            {% if not request.user.profile.is_guide %}
            <button class="book-button"> <a href="{% url 'tours:book_tour' tour.id %}" style="color: white">Book</a></button>
            <div class="tour-reviews">
                <h4>Reviews</h4>
                <button class="review-button"> <a href="{% url 'tours:add_review' tour.id %}" style="color: white">Add Review</a></button>
                {% for review in tour.reviews.all %}
                <div class="review">
                    <strong>{{ review.author.user.username }}</strong>
                    <p class="review-rating">Rating: {{ review.rating }}</p>
                    <p class="review-content">{{ review.content }}</p>
                </div>
                {% empty %}
                <p>No reviews yet.</p>
                {% endfor %}
            </div>
            {% endif %}
        {% else %}
        <p><a href="{% url 'users:login' %}">Log in</a> to book or rate tours.</p>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endblock %}
{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var modal = document.getElementById('mapModal');
    var closeBtn = document.getElementsByClassName('close-button')[0];
    var map = null;  // Initialize map variable

    function initMap(lat, lng, locationName) {
        if (map !== null) {
            map.remove();  // This ensures the map is properly destroyed
        }
        // Recreate the map div dynamically
        document.getElementById('map').innerHTML = "<div id='newMap' style='height: 400px; width: 100%;'></div>";
        map = L.map('newMap').setView([lat, lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        L.marker([lat, lng]).addTo(map)
            .bindPopup(locationName)
            .openPopup();
    }

    closeBtn.onclick = function() {
        modal.style.display = "none";
    };

    window.onclick = function(event) {
        if (event.target === modal) {
            modal.style.display = "none";
        }
    };

    window.showMap = function(lat, lng, locationName) {  // Make showMap global
        modal.style.display = 'block';
        initMap(lat, lng, locationName);  // Initialize map with new coordinates
    };
});
</script>
{% endblock %}
